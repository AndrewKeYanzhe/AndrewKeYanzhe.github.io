<html><head>  
	<title>Stats</title>
	<style type="text/css">

	@media screen and (min-width: 601px) {
		div, label, input, button {
			font-size: 25px;
		}
	}

	/* If the screen size is 600px wide or less, set the font-size of <div> to 30px */
	@media screen and (max-width: 600px) {
		div, button {
			font-size: 6vw;
		}
		label, input{
			font-size: 3vw;
		}
	}
	input	{
		width:100%;
	}

	@media only screen 
	and (min-device-width: 375px) 
	and (max-device-width: 667px) 
	and (-webkit-min-device-pixel-ratio: 2) { 
		div, button {
			font-size: 6vw;
		}
		label, input{
			font-size: 3vw;
		}

	}

</style>
</head>
<body>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script>
		const varToString = varObj => Object.keys(varObj)[0]

		function getEtherPrice() {
			//for ETH to SGD
			let apiUrl = "https://min-api.cryptocompare.com/data/price?fsym=eth&tsyms=sgd"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.SGD)
				})
				.catch(error => console.error(error));
			});
		}

		function getEtherPrice2() {
			//for ETH to SGD
			let apiUrl = "https://api.coinbase.com/v2/exchange-rates?currency=sgd"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.data.rates.ETH**-1)
				})
				.catch(error => {
					console.error(error)
					resolve("failed to get ETH-SGD")
					});
			});
		}

		function getEthermineDashboard(minerAddress) {
			let apiUrl = "https://api.ethermine.org/miner/" + minerAddress + "/dashboard"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.data)
				})
				.catch(error => console.error(error));
			});
		}



		function getEthermineCurrentStats(minerAddress) {
			let apiUrl = "https://api.ethermine.org/miner/" + minerAddress + "/currentStats"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					resolve(response.data.data)
				})
				.catch(error => console.error(error));
			});
		}


		function showSample(){
			document.getElementById("minerAddress").value = "0x239bb422Cc8254b64838f396555C64c8cB68dcf7"
			document.getElementById("acceptedHashrate").value = 29
			document.getElementById("dailyElectrictyCost").value = 0.7955697024000000
			document.getElementById("miningBeganTimestamp").value = "2021-03-24T18:00:00.000+08:00"
			document.getElementById("breaksFromMining").value = 40


		}

		function showSettings(){
			if(document.getElementById("settings").style.display == 'none'){
				document.getElementById("settings").style.display = 'block'

				document.getElementById("minerAddress").value = minerAddress
				document.getElementById("acceptedHashrate").value = acceptedHashrate
				document.getElementById("dailyElectrictyCost").value = dailyElectrictyCost
				document.getElementById("miningBeganTimestamp").value = miningBeganTimestamp
				document.getElementById("breaksFromMining").value = breaksFromMining
			}
			else{
				document.getElementById("settings").style.display = 'none'
			}
		}

		function applySettings(){
			document.getElementById("unpaidEth").innerText = "Fetching"
			document.getElementById("dailyEth").innerText = "Fetching"
			document.getElementById("dailyProfitSgd").innerText = "Fetching"
			document.getElementById("totalProfitSgd").innerText = "Fetching"



			minerAddress = document.getElementById("minerAddress").value
			acceptedHashrate = document.getElementById("acceptedHashrate").value
			dailyElectrictyCost = document.getElementById("dailyElectrictyCost").value
			miningBeganTimestamp = document.getElementById("miningBeganTimestamp").value
			breaksFromMining = document.getElementById("breaksFromMining").value		

			setCookie(varToString({minerAddress}),minerAddress)
			setCookie(varToString({acceptedHashrate}),acceptedHashrate)
			setCookie(varToString({dailyElectrictyCost}),dailyElectrictyCost)
			setCookie(varToString({miningBeganTimestamp}),miningBeganTimestamp)
			setCookie(varToString({breaksFromMining}),breaksFromMining)
			console.log(document.cookie)

			asyncCall()
		}

		let minerAddress = getCookie("minerAddress")
		let acceptedHashrate = getCookie("acceptedHashrate") //long run accepted hashrate from your mining pool
		let breaksFromMining = getCookie("breaksFromMining")
		let dailyElectrictyCost = getCookie("dailyElectrictyCost")
		let miningBeganTimestamp = getCookie("miningBeganTimestamp")

		if (!(minerAddress || acceptedHashrate || breaksFromMining || dailyElectrictyCost || miningBeganTimestamp)){
			console.log("No cookies set")
			minerAddress = "0x239bb422Cc8254b64838f396555C64c8cB68dcf7"
			acceptedHashrate = 29 //in MH/s
			breaksFromMining = 40 //in hours
			dailyElectrictyCost = 0.7955697024000000 //sgd
			miningBeganTimestamp = "2021-03-24T18:00:00.000+08:00"

			setCookie(varToString({minerAddress}),minerAddress)
			setCookie(varToString({acceptedHashrate}))
			setCookie(varToString({dailyElectrictyCost}),dailyElectrictyCost)
			setCookie(varToString({miningBeganTimestamp}),miningBeganTimestamp)
			setCookie(varToString({breaksFromMining}),breaksFromMining)

		}

		async function asyncCall() {

			console.log('calling');
			let ethermineDashboard = getEthermineDashboard(minerAddress);
			let ethPrice = getEtherPrice2() //in SGD, using coinbase
			let ethermineCurrentStats = getEthermineCurrentStats(minerAddress)
			
			ethermineDashboard = await ethermineDashboard
			ethPrice = await ethPrice
			ethermineCurrentStats = await ethermineCurrentStats
			// WhatToMineStats = await getWhatToMineStats(29.2)

			// let ethPrice2 = await getEtherPrice2()
			// console.log(1/ethPrice2)

			console.log(ethermineDashboard);
			console.log(ethPrice)
			console.log(ethermineCurrentStats)


			let unpaidEth = ethermineDashboard.currentStatistics.unpaid/10**18
			let unpaidBalSgd = unpaidEth*ethPrice
			let ethPerDay = ethermineCurrentStats.coinsPerMin*60*24*acceptedHashrate*10**6/ethermineCurrentStats.averageHashrate
			// console.log(ethPerDay)
			/*
			ethermine provides coinsPerMin as a 24HR moving average based on network rewards/difficulty and your hashrate submitted in the last 24hrs
			
			Thus, if you have not mined for 24 full hours, you will not know your instantaneous payrate

			this formula provides instantaneous payrate by multiplying your payrate by (long term accepted hashrate)/(hashrate over past 24Hrs) 

			instantaneous payrate should be similar to values obtained from whattomine, minus fees (e.g. 0.75% teamredminer, 1% ethermine, 1% stale rate)
			*/

			dailyProfitSgd = ethPerDay*ethPrice - dailyElectrictyCost





			currentTime = new Date()
			miningBegan = new Date(miningBeganTimestamp);
			// console.log(currentTime)
			// console.log(miningBegan)
			daysElapsed = (currentTime - miningBegan)/24/60/60/1000
			// console.log(daysElapsed)
			daysMined = daysElapsed - breaksFromMining/24
			// console.log(daysMined)
			totalCost = daysMined*dailyElectrictyCost
			// console.log(totalCost)
			totalProfitSgd = unpaidBalSgd - totalCost


			document.getElementById("unpaidEth").innerText = unpaidEth.toFixed(6);
			// document.getElementById("unpaidBalSgd").innerText = unpaidBalSgd.toFixed(2);
			document.getElementById("totalProfitSgd").innerText = totalProfitSgd.toFixed(2);
			document.getElementById("dailyEth").innerText = ethPerDay.toFixed(5)
			document.getElementById("dailyProfitSgd").innerText = dailyProfitSgd.toFixed(2)

		}

		function getCookie(cname) {
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}
		// function writeCookies(minerAddress,dailyElectrictyCost,miningBeganTimestamp,breaksFromMining){
		// 	document.cookie = "value ="minerAddress + dailyElectrictyCost + miningBeganTimestamp +breaksFromMining + "; expires=Thu, 18 Dec 2013 12:00:00"
		// }

		function setCookie(cname, cvalue) {
		  // var d = new Date();
		  // d.setTime(d.getTime() + (exdays*24*60*60*1000));
		  var expires = "expires="+ "2037-03-24T18:00:00.000+08:00";
		  document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}

		asyncCall();



	</script>

	<div style="margin: auto;
	text-align:center;
	font-family: Verdana, Geneva, sans-serif;
	font-weight: bold;
	/*font-size: 6vw;*/
	line-height: 200%;
	position: absolute;
	top: 20%;
	left: 50%;
	/*transform: translate(-50%, -50%);*/
	transform: translate(-50%,0%);
	width: 80%;">

	Unpaid ETH: <span id="unpaidEth">Fetching</span><br>		
	<!-- Unpaid SGD: <span id="unpaidBalSgd">Fetching</span><br>		 -->
	ETH/day: <span id="dailyEth">Fetching</span><br>	
	SGD profit/day: <span id="dailyProfitSgd">Fetching</span><br>	
	Total SGD profit: <span id="totalProfitSgd">Fetching</span><br>	

	<br>
	<button onclick="showSettings()">Settings</button>
	<p></p>	
	<div id="settings" style="display: none">

		<label for="minerAddress">Ethereum address:</label><br>
		<input type="text" id="minerAddress" name=""><br>
		<label for="acceptedHashrate">Average accepted hashrate:</label><br>
		<input type="text" id="acceptedHashrate" name=""><br>
		<label for="dailyElectrictyCost">Daily electricity cost in SGD:</label><br>
		<input type="text" id="dailyElectrictyCost" name=""><br>
		<label for="miningBeganTimestamp">Time when mining began:</label><br>
		<input type="text" id="miningBeganTimestamp" name=""><br>
		<label for="breaksFromMining">Hours of breaks from mining:</label><br>
		<input type="text" id="breaksFromMining" name=""><br>
		<br>
		<button onclick="applySettings()">Save</button>
		<button onclick="showSample()">Sample</button>
	</div>
	<br>
	<br>
</div>



</body></html>