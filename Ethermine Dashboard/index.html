<html><head>  
	<title>Stats</title>
	<style type="text/css">

	@media screen and (min-width: 601px) {
		div, label, input, button {
			font-size: 25px;
		}
	}

	/* If the screen size is 600px wide or less, set the font-size of <div> to 30px */
	@media screen and (max-width: 600px) {
		div, button {
			font-size: 6vw;
		}
		label, input{
			font-size: 3vw;
		}
	}
	input	{
		width:100%;
	}

	/*for iphone*/
	@media only screen 
	and (min-device-width: 375px) 
	and (max-device-width: 667px) 
	and (-webkit-min-device-pixel-ratio: 2) { 
		div, button {
			font-size: 6vw;
		}
		label, input{
			font-size: 3vw;
		}

	}

</style>
</head>
<body>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script>
		let sampleMinerAddress = "0x239bb422Cc8254b64838f396555C64c8cB68dcf7"
		let sampleAcceptedHashrate = 30.4 //in MH/s (please deduct fees e.g. 0.75% teamredminer, 1% ethermine, 1% stale rate)
		let sampleBreaksFromMining = 40 //in hours
		let sampleDailyElectrictyCost = 0.7955697024000000 //sgd
		let sampleMiningBeganTimestamp = "2021-03-24T18:00:00.000+08:00"

		const varToString = varObj => Object.keys(varObj)[0]

		function getEtherPrice() {
			//for ETH to SGD
			let apiUrl = "https://min-api.cryptocompare.com/data/price?fsym=eth&tsyms=sgd"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.SGD)
				})
				.catch(error => console.error(error));
			});
		}

		function getEtherPrice2() {
			//for ETH to SGD
			let apiUrl = "https://api.coinbase.com/v2/exchange-rates?currency=sgd"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.data.rates.ETH**-1)
				})
				.catch(error => {
					console.error(error)
					resolve("failed to get ETH-SGD")
				});
			});
		}

		function getethWalletInfo(minerAddress){
			let apiUrl = "https://api.ethplorer.io/getAddressInfo/" + minerAddress + "?apiKey=freekey"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data)
				})
				.catch(error => console.error(error));
			});
					
		}

		function getEthermineDashboard(minerAddress) {
			let apiUrl = "https://api.ethermine.org/miner/" + minerAddress + "/dashboard"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					// console.log(response.data.data.currentStatistics.unpaid);
					resolve(response.data.data)
				})
				.catch(error => console.error(error));
			});
		}

		function getEthermineCurrentStats(minerAddress) {
			let apiUrl = "https://api.ethermine.org/miner/" + minerAddress + "/currentStats"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					resolve(response.data.data)
				})
				.catch(error => console.error(error));
			});
		}

		function getEthermineWorkerInfo(minerAddress) {
			let apiUrl = "https://api.ethermine.org/miner/" + minerAddress + "/workers"
			return new Promise(resolve => {
				axios
				.get(apiUrl)
				.then(response => {
					// console.log(response.data.data)
					resolve(response.data.data)
				})
				.catch(error => console.error(error));
			});
		}

		function showSample(){
			document.getElementById("minerAddress").value = sampleMinerAddress
			document.getElementById("acceptedHashrate").value = sampleAcceptedHashrate
			document.getElementById("dailyElectrictyCost").value = sampleDailyElectrictyCost
			document.getElementById("miningBeganTimestamp").value = sampleMiningBeganTimestamp
			document.getElementById("breaksFromMining").value = sampleBreaksFromMining
		}

		function showSettings(){
			if(document.getElementById("settings").style.display == 'none'){
				document.getElementById("settings").style.display = 'block'

				document.getElementById("minerAddress").value = minerAddress
				document.getElementById("acceptedHashrate").value = acceptedHashrate
				document.getElementById("dailyElectrictyCost").value = dailyElectrictyCost
				document.getElementById("miningBeganTimestamp").value = miningBeganTimestamp
				document.getElementById("breaksFromMining").value = breaksFromMining
			}
			else{
				document.getElementById("settings").style.display = 'none'
			}
		}

		function applySettings(){
			document.getElementById("totalEth").innerText = "Fetching"
			document.getElementById("dailyEth").innerText = "Fetching"
			document.getElementById("dailyProfitSgd").innerText = "Fetching"
			document.getElementById("profitSgd").innerText = "Fetching"

			minerAddress = document.getElementById("minerAddress").value
			acceptedHashrate = document.getElementById("acceptedHashrate").value
			dailyElectrictyCost = document.getElementById("dailyElectrictyCost").value
			miningBeganTimestamp = document.getElementById("miningBeganTimestamp").value
			breaksFromMining = document.getElementById("breaksFromMining").value		

			setCookie(varToString({minerAddress}),minerAddress)
			setCookie(varToString({acceptedHashrate}),acceptedHashrate)
			setCookie(varToString({dailyElectrictyCost}),dailyElectrictyCost)
			setCookie(varToString({miningBeganTimestamp}),miningBeganTimestamp)
			setCookie(varToString({breaksFromMining}),breaksFromMining)
			console.log(document.cookie)

			asyncCall()
		}

		function getCookie(cname) {
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}

		function setCookie(cname, cvalue) {
			var expires = "expires="+ "2037-03-24T18:00:00.000+08:00";
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}


		async function asyncCall() {
			console.log('calling');
			let ethermineDashboard = getEthermineDashboard(minerAddress);
			let ethPrice = getEtherPrice2() //in SGD, using coinbase
			let ethermineCurrentStats = getEthermineCurrentStats(minerAddress)
			let ethermineWorkerInfo = getEthermineWorkerInfo(minerAddress)
			let ethWalletInfo = getethWalletInfo(minerAddress)
			
			ethermineDashboard = await ethermineDashboard
			ethPrice = await ethPrice
			ethermineCurrentStats = await ethermineCurrentStats
			ethermineWorkerInfo = await ethermineWorkerInfo
			ethWalletInfo = await ethWalletInfo

			console.log({ethermineDashboard});	//to get unpaid eth value
			console.log({ethPrice})
			console.log({ethermineCurrentStats})	//to get coinsPerMin and avgHashrate
			console.log({ethermineWorkerInfo})	//to get another sample of avgHashrate
			console.log({ethWalletInfo})
			console.log("")


			let unpaidEth = ethermineDashboard.currentStatistics.unpaid/10**18
			console.log({unpaidEth})
			let walletEth = ethWalletInfo.ETH.balance
			console.log({walletEth})
			let totalEth = walletEth + unpaidEth
			console.log({totalEth})
			console.log("")


			/*
			ethermine provides REWARDS PER UNIT TIME based on your AVERAGE hashrate over the last 24 hours.

			Thus, if you did not mine for a full 24 hours, your AVERAGE hashrate will be lower than your INSTANTANEOUS hashrate

			Your instantaneous REWARDS PER UNIT TIME is estimated here, by multiplying by (instantaneous hashrate)/(last 24hr avg hashrate)

			ethermine provides 2 values for (last 24hr avg hashrate), both are displayed below. currentstats seems to provide the more accurate value.
			*/
			console.log("unmodified daily payrate: " + ethermineCurrentStats.coinsPerMin*60*24)			
			console.log("currentstats api avg    : " + ethermineCurrentStats.averageHashrate/10**6)
			console.log("currentstats api payrate: " + ethermineCurrentStats.coinsPerMin*60*24*acceptedHashrate/(ethermineCurrentStats.averageHashrate/10**6))
			console.log("workerinfo   api avg    : " + ethermineWorkerInfo[0].averageHashrate/10**6)
			console.log("workerinfo   api payrate: " + ethermineCurrentStats.coinsPerMin*60*24*acceptedHashrate/(ethermineWorkerInfo[0].averageHashrate/10**6))
			console.log("")
			// let avgHashrateOverLastDay = ethermineWorkerInfo[0].averageHashrate/10**6
			let avgHashrateOverLastDay = ethermineCurrentStats.averageHashrate/10**6			
			let totalBalSgd = totalEth*ethPrice
			let ethPerDay = ethermineCurrentStats.coinsPerMin*60*24*acceptedHashrate/avgHashrateOverLastDay
			// console.log(ethPerDay)
			

			dailyProfitSgd = ethPerDay*ethPrice - dailyElectrictyCost





			currentTime = new Date()
			miningBegan = new Date(miningBeganTimestamp);
			// console.log(currentTime)
			// console.log(miningBegan)
			daysElapsed = (currentTime - miningBegan)/24/60/60/1000
			// console.log(daysElapsed)
			daysMined = daysElapsed - breaksFromMining/24
			// console.log(daysMined)
			totalCost = daysMined*dailyElectrictyCost
			// console.log(totalCost)
			profitSgd = totalBalSgd - totalCost


			document.getElementById("totalEth").innerText = totalEth.toFixed(6);
			document.getElementById("profitSgd").innerText = profitSgd.toFixed(2);
			document.getElementById("dailyEth").innerText = ethPerDay.toFixed(5)
			document.getElementById("dailyProfitSgd").innerText = dailyProfitSgd.toFixed(2)

		}

		let minerAddress = getCookie("minerAddress")
		let acceptedHashrate = getCookie("acceptedHashrate") //long run accepted hashrate from your mining pool
		let breaksFromMining = getCookie("breaksFromMining")
		let dailyElectrictyCost = getCookie("dailyElectrictyCost")
		let miningBeganTimestamp = getCookie("miningBeganTimestamp")

		if (!(minerAddress || acceptedHashrate || breaksFromMining || dailyElectrictyCost || miningBeganTimestamp)){
			console.log("No cookies set")
			minerAddress = sampleMinerAddress
			acceptedHashrate = sampleAcceptedHashrate
			breaksFromMining = sampleBreaksFromMining
			dailyElectrictyCost = sampleDailyElectrictyCost
			miningBeganTimestamp = sampleMiningBeganTimestamp

			setCookie(varToString({minerAddress}),minerAddress)
			setCookie(varToString({acceptedHashrate}),acceptedHashrate)
			setCookie(varToString({dailyElectrictyCost}),dailyElectrictyCost)
			setCookie(varToString({miningBeganTimestamp}),miningBeganTimestamp)
			setCookie(varToString({breaksFromMining}),breaksFromMining)
		}




		asyncCall();



	</script>

	<div style="margin: auto;
	text-align:center;
	font-family: Verdana, Geneva, sans-serif;
	font-weight: bold;
	/*font-size: 6vw;*/
	line-height: 200%;
	position: absolute;
	top: 20%;
	left: 50%;
	/*transform: translate(-50%, -50%);*/
	transform: translate(-50%,0%);
	width: 80%;">

	Unpaid ETH: <span id="totalEth">Fetching</span><br>		
	ETH/day: <span id="dailyEth">Fetching</span><br>	
	SGD profit/day: <span id="dailyProfitSgd">Fetching</span><br>	
	Total SGD profit: <span id="profitSgd">Fetching</span><br>	

	<br>
	<button onclick="showSettings()">Settings</button>
	<p></p>	
	<div id="settings" style="display: none">

		<label for="minerAddress">Ethereum address:</label><br>
		<input type="text" id="minerAddress" name=""><br>
		<label for="acceptedHashrate">Average accepted hashrate:</label><br>
		<input type="text" id="acceptedHashrate" name=""><br>
		<label for="dailyElectrictyCost">Daily electricity cost in SGD:</label><br>
		<input type="text" id="dailyElectrictyCost" name=""><br>
		<label for="miningBeganTimestamp">Time when mining began:</label><br>
		<input type="text" id="miningBeganTimestamp" name=""><br>
		<label for="breaksFromMining">Hours of breaks from mining:</label><br>
		<input type="text" id="breaksFromMining" name=""><br>
		<br>
		<button onclick="applySettings()">Save</button>
		<button onclick="showSample()">Sample</button>
	</div>
	<br>
	<br>
</div>



</body></html>